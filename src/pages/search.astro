---
// src/pages/search.astro
import { SITE_TITLE } from '../consts';
import Layout from '../layouts/Layout.astro';
import Card from '../components/Card.astro';

const query = Astro.url.searchParams.get('query');
// 1. Gunakan Astro.glob() untuk memuat semua file .md dan .mdx
const allPosts = await Astro.glob('../content/blog/*.{md,mdx}');

let results = [];

if (query) {
  const lowerQuery = query.toLowerCase(); // Ubah ke huruf kecil HANYA SEKALI

  results = allPosts.filter(post => {
    // 2. Akses frontmatter dengan aman, dan handle jika properti tidak ada
    const title = (post.frontmatter.title || '').toLowerCase();
    const description = (post.frontmatter.description || '').toLowerCase();
    // 3. Gunakan compiledContent() untuk mendapatkan konten HTML yang sudah di-render
    const content = (post.compiledContent() || '').toLowerCase();


    // 4. Lakukan pencarian (case-insensitive)
    return (
      title.includes(lowerQuery) ||
      description.includes(lowerQuery) ||
      content.includes(lowerQuery)
    );
  });
}
---

<Layout title={query ? `Search: ${query} - ${SITE_TITLE}` : `Search - ${SITE_TITLE}`}>
  <main>
    <section>
      <h1>{query ? `Hasil Pencarian: "${query}"` : 'Search'}</h1>
      {query ? (
          results.length === 0 ? (
            <p>Tidak ada hasil yang ditemukan untuk "{query}".</p>
          ) : (
            <ul class="post-list">
              {results.map((post) => (
                // 5. Teruskan frontmatter dan url ke komponen Card
                <Card frontmatter={post.frontmatter} url={post.url} />
              ))}
            </ul>
          )
        ) : (
          <p>Masukkan kata kunci untuk mencari.</p>
        )
      }
    </section>
  </main>
</Layout>

<style>
  .post-list {
    list-style: none;
    padding: 0;
  }
  /* Tambahkan styling lain jika diperlukan di sini */
</style>
